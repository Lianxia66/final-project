---
title: "Final project"
author: "Hyeyoon Lee, Lianxia Chi"
date: "2024-10-05"
format: html
execute:
  eval: true
  echo: true
---
1. Data Loading and Cleaning
```{python}
import pandas as pd
import numpy as np
data_path = "/Users/hyeyoonsmacbook/Desktop/Github/final-project/data/"
df_cait_2020 = pd.read_csv(f'{data_path}CO2 emissions by sector (CAIT, 2020).csv')
df_cait_2021 = pd.read_csv(f'{data_path}CO2 emissions by sector (CAIT, 2021).csv')
df_cdiac_2017 = pd.read_csv(f'{data_path}CO2 from gas - CDIAC (2017).csv')
df_owid_co2 = pd.read_csv(f'{data_path}owid-co2-data.csv')
df_energy = pd.read_csv(f'{data_path}owid-energy-data.csv')
df_profit_2020 = pd.read_csv(f'{data_path}Public profit and emission database의 사본 - 2020.csv')
df_profit_2021 = pd.read_csv(f'{data_path}Public profit and emission database의 사본 - 2021.csv')
df_profit_2022 = pd.read_csv(f'{data_path}Public profit and emission database의 사본 - 2022.csv')
df_profit_2020.rename(columns={
    'Company Name': 'Company',
    'Country/Territory ': 'Country',
    'Industry': 'Industry',
    'Profit': 'Profit',
    'Scope 1-3 emissions': 'Emissions'
}, inplace=True)

df_profit_2021.rename(columns={
    'Company Name': 'Company',
    '2021 Forbes Rank\n(2022 list) ': 'Global Rank',
    '2021 Scope 1-3': 'Emissions',
    '2021 Profit (Million USD)': 'Profit',
    '2021 Sales / Revenue (Million USD)': 'Revenue'
}, inplace=True)

df_profit_2022.rename(columns={
    'Company Name': 'Company',
    '2022 Scope 1-3 emissions': 'Emissions',
    '2022 Profit (Million USD)': 'Profit',
    '2022 Sales / Revenue (Million USD)': 'Revenue'
}, inplace=True)
df_profit_combined = pd.concat([df_profit_2020, df_profit_2021, df_profit_2022], ignore_index=True)
df_profit_combined_filtered = df_profit_combined[['Company', 'Country', 'Industry', 'Profit', 'Emissions']].copy()
df_profit_combined_filtered.loc[:, 'Profit'] = (
    df_profit_combined_filtered['Profit']
    .str.replace(r'[\s$,−]', '', regex=True) 
    .astype(float)
)

df_profit_combined_filtered.loc[:, 'Emissions'] = (
    df_profit_combined_filtered['Emissions']
    .str.replace(r'[\s$,−]', '', regex=True) 
    .replace('', np.nan)
    .astype(float)
)

emissions_median = df_profit_combined_filtered['Emissions'].median()
df_profit_combined_filtered.loc[:, 'Emissions'].fillna(emissions_median, inplace=True)
print(df_profit_combined_filtered.head())

### First Part ###
import pandas as pd

# Define function to clean numeric columns
def convert_numeric_columns(df, cols):
    """
    Convert specified columns to numeric after cleaning unwanted characters.
    """
    for col in cols:
        if col in df.columns:
            # Use raw strings to avoid warnings
            df[col] = (
                df[col]
                .replace(r'[\$,]', '', regex=True)  # Remove dollar signs and commas
                .replace(r'[—]', '0', regex=True)  # Replace dashes with 0
                .replace(' ', '', regex=True)  # Remove non-breaking spaces
            )
            df[col] = pd.to_numeric(df[col], errors='coerce')  # Convert to numeric
    return df

# Define function to standardize column names
def standardize_columns(df, year=None):
    """
    Standardize column names: lowercase, replace spaces with underscores, and add year prefix.
    """
    df.columns = (
        df.columns.str.strip().str.lower().str.replace(' ', '_').str.replace('\n', '_')
    )
    # Add year prefix if provided, except for key columns
    if year:
        df = df.rename(columns=lambda x: f"{x}_{year}" if x not in ['company_name', 'industry'] else x)
    return df

# File paths for the datasets
file_2020 = '/Users/joying/Documents/GitHub/Final Project /Data Base for FP/Public profit and emission database - 2020.csv'
file_2021 = '/Users/joying/Documents/GitHub/Final Project /Data Base for FP/Public profit and emission database - 2021.csv'
file_2022 = '/Users/joying/Documents/GitHub/Final Project /Data Base for FP/Public profit and emission database - 2022.csv'

# Load datasets
data_2020 = pd.read_csv(file_2020)
data_2021 = pd.read_csv(file_2021)
data_2022 = pd.read_csv(file_2022)

# Standardize column names
data_2020_cleaned = standardize_columns(data_2020, year=2020)
data_2021_cleaned = standardize_columns(data_2021, year=2021)
data_2022_cleaned = standardize_columns(data_2022, year=2022)

# Convert numeric columns for each dataset
numeric_cols_2020 = ['scope_1_ghg_emissions_tons_co₂e_2020', 'scope_2_emissions__tons_co₂e_2020', 'profit_2020']
numeric_cols_2021 = ['2021_scope_1_emissions_tons_co₂e_2021', '2021_scope_2_emissions_tons_co₂e_2021', '2021_profit_(million_usd)_2021']
numeric_cols_2022 = ['2022_scope_1_emissions_tons_co₂e_2022', '2022_scope_2_emissions_tons_co₂e_2022', '2022_profit_(millions_usd)_2022']

data_2020_cleaned = convert_numeric_columns(data_2020_cleaned, numeric_cols_2020)
data_2021_cleaned = convert_numeric_columns(data_2021_cleaned, numeric_cols_2021)
data_2022_cleaned = convert_numeric_columns(data_2022_cleaned, numeric_cols_2022)

# Combine datasets
merged_data = pd.concat([data_2020_cleaned, data_2021_cleaned, data_2022_cleaned], ignore_index=True)

# Drop duplicates based on 'company_name'
if 'company_name' in merged_data.columns:
    merged_data = merged_data.drop_duplicates(subset=['company_name'], keep='first')
else:
    print("Error: 'company_name' column is missing in the merged dataset.")

# Check and print standardized column names
print("Merged Dataset Columns:", merged_data.columns)

# Check for missing values
missing_values_summary = merged_data.isnull().sum()
print("\nMissing Values Summary:")
print(missing_values_summary)

# Save cleaned and merged data for further use
merged_data.to_csv('/Users/joying/Documents/GitHub/Final Project /Data Base for FP/merged_cleaned_data.csv', index=False)


```
